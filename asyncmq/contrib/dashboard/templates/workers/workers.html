{% extends "layout.html" %}
{% block content %}
  <h1 class="text-3xl font-semibold mb-6">Workers Overview</h1>

  <!-- Workers Table -->
  <div class="bg-white ring-1 ring-gray-200 shadow overflow-x-auto mb-8">
    <table class="min-w-full table-auto divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">
            ID
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">
            Queue
          </th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">
            Concurrency
          </th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">
            Last Heartbeat
          </th>
        </tr>
      </thead>
      <tbody id="worker-rows" class="bg-white divide-y divide-gray-200">
        {% for w in workers %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">
              {{ w.id }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
              {{ w.queue }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
              {{ w.concurrency }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">
              <time datetime="{{ w.heartbeat }}">{{ w.heartbeat }}</time>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="4" class="px-6 py-8 text-center text-gray-500 italic">
              No workers currently registered.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Charts Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Concurrency by Worker -->
    <div class="bg-white ring-1 ring-gray-200 shadow p-6 flex flex-col">
      <h2 class="text-lg font-semibold mb-4">Concurrency by Worker</h2>
      <div class="flex-1">
        <canvas id="worker-concurrency-chart" class="w-full h-56"></canvas>
      </div>
    </div>
    <!-- Workers per Queue Pie -->
    <div class="bg-white ring-1 ring-gray-200 shadow p-6 flex flex-col">
      <h2 class="text-lg font-semibold mb-4">Workers per Queue</h2>
      <div class="flex-1 flex items-center justify-center">
        <canvas id="worker-queue-pie-chart" class="w-2/3 h-2/3"></canvas>
      </div>
    </div>
  </div>

  <!-- Chart.js & SSE Script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const source = new EventSource('{{ url_prefix }}/events');

    // Prepare charts
    const wcCtx = document.getElementById('worker-concurrency-chart').getContext('2d');
    const wqCtx = document.getElementById('worker-queue-pie-chart').getContext('2d');

    const wcChart = new Chart(wcCtx, {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Concurrency', data: [], backgroundColor: 'rgba(59,130,246,0.7)' }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
        plugins: { legend: { display: false } },
        animation: { duration: 0 },
      }
    });

    const wqChart = new Chart(wqCtx, {
      type: 'doughnut',
      data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        animation: { duration: 0 },
      }
    });

    source.addEventListener('workers', e => {
      const list = JSON.parse(e.data);

      // Update table
      const tbody = document.getElementById('worker-rows');
      tbody.innerHTML = '';
      list.forEach(w => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">${w.id}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${w.queue}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">${w.concurrency}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">${new Date(w.heartbeat*1000).toLocaleTimeString()}</td>
        `;
        tbody.appendChild(tr);
      });

      // Concurrency chart
      wcChart.data.labels = list.map(w => w.id);
      wcChart.data.datasets[0].data = list.map(w => w.concurrency);
      wcChart.update();

      // Workers-per-queue pie
      const counts = {};
      list.forEach(w => counts[w.queue] = (counts[w.queue]||0)+1);
      wqChart.data.labels = Object.keys(counts);
      wqChart.data.datasets[0].data = Object.values(counts);
      wqChart.data.datasets[0].backgroundColor = wqChart.data.labels.map((_, i) =>
        `hsl(${(i*60)%360},65%,55%)`
      );
      wqChart.update();
    });

    source.onerror = () => console.warn('SSE error on workers – retrying…');
  </script>
{% endblock %}
